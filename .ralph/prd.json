{
  "project": "TodayMatters",
  "branchName": "ralph/location-informed-actual-ingestion",
  "description": "Location-Informed Actual Ingestion with Sessionization - Fix the moving calendar problem, add location evidence, and create human-readable place-anchored session blocks",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create window locks table migration",
      "description": "As a developer, I need a table to track which 30-min windows have been processed so they're never reprocessed.",
      "acceptanceCriteria": [
        "Create migration file for tm.actual_ingestion_window_locks table",
        "Table has columns: id (uuid), user_id (uuid FK), window_start (timestamptz), window_end (timestamptz), locked_at (timestamptz), stats (jsonb)",
        "Add UNIQUE constraint on (user_id, window_start)",
        "Add index on (user_id, window_start) for fast lookups",
        "Migration runs successfully",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Migration created: supabase/migrations/20260129_create_tm_actual_ingestion_window_locks.sql"
    },
    {
      "id": "US-002",
      "title": "Add locked_at column to events table",
      "description": "As a developer, I need to mark events as immutable after their window is processed.",
      "acceptanceCriteria": [
        "Create migration to add locked_at timestamptz column to tm.events",
        "Column is nullable (null = not yet locked)",
        "Add partial index on (user_id, locked_at) WHERE locked_at IS NOT NULL",
        "Migration runs successfully",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Migration created: supabase/migrations/20260129_add_locked_at_to_tm_events.sql"
    },
    {
      "id": "US-003",
      "title": "Create user_app_categories table migration",
      "description": "As a developer, I need a table to store user overrides for app categorization.",
      "acceptanceCriteria": [
        "Create migration for tm.user_app_categories table",
        "Table has columns: id (uuid), user_id (uuid FK), app_id (text), category (text), created_at (timestamptz)",
        "Category values: 'work', 'social', 'entertainment', 'comms', 'utility', 'ignore'",
        "Add UNIQUE constraint on (user_id, app_id)",
        "Migration runs successfully",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Table already existed in 20260119_user_app_categories_learning.sql. Added CHECK constraint for category values: supabase/migrations/20260129_user_app_categories_check_constraint.sql"
    },
    {
      "id": "US-004",
      "title": "Add window lock check to ingestion pipeline",
      "description": "As a developer, I need the ingestion pipeline to skip already-processed windows.",
      "acceptanceCriteria": [
        "Add function isWindowLocked(userId, windowStart) that queries tm.actual_ingestion_window_locks",
        "Add function lockWindow(userId, windowStart, windowEnd, stats) that inserts lock record",
        "Update processIngestionWindow to check lock before processing",
        "If window is locked, return early with { skipped: true }",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Service created: apps/mobile/src/lib/supabase/services/actual-ingestion-window-locks.ts. Functions: isWindowLocked, lockWindow, processIngestionWindow (with lock check), getWindowLock, getLockedWindowsInRange, checkWindowLockBeforeProcessing."
    },
    {
      "id": "US-005",
      "title": "Implement event immutability in reconciliation",
      "description": "As a developer, I need the reconciliation logic to respect locked events.",
      "acceptanceCriteria": [
        "Update computeReconciliationOps to treat events with locked_at as protected",
        "Locked events cannot be deleted or modified during reconciliation",
        "After window processing, set locked_at on all new events in that window",
        "Unit test: locked events are never included in delete operations",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Service created: apps/mobile/src/lib/supabase/services/event-reconciliation.ts. Functions: computeReconciliationOps (with locked event protection), lockEventsInWindow, fetchEventsInWindow, hasLockedEventsInWindow, getLockedEventsInRange. 12 unit tests pass in event-reconciliation.test.ts."
    },
    {
      "id": "US-006",
      "title": "Implement trailing edge extension for screen-time",
      "description": "As a developer, I need continuous screen-time sessions to extend rather than create duplicates.",
      "acceptanceCriteria": [
        "Add function findExtendableEvent(userId, windowStart, appId) that finds the most recent event ending near window start",
        "If same app_id and gap < 60s, extend scheduled_end instead of creating new event",
        "Only extend the single most recent event (not multiple)",
        "Update reconciliation to use extension logic",
        "Unit test: continuous session across windows creates one event",
        "Unit test: gap > 60s creates separate events",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Functions added to event-reconciliation.ts: findExtendableEvent, computeReconciliationOpsWithExtension, canExtendEvent, fetchExtensionCandidates, extendEvent, executeExtensions. 17 new unit tests in event-reconciliation.test.ts (29 total)."
    },
    {
      "id": "US-007",
      "title": "Create fetchLocationEvidenceForWindow function",
      "description": "As a developer, I need to retrieve location data for the ingestion window.",
      "acceptanceCriteria": [
        "New function fetchLocationEvidenceForWindow(userId, windowStart, windowEnd) in evidence-data.ts",
        "Queries tm.location_samples for raw GPS points in the time window",
        "Queries tm.location_hourly for aggregated place data",
        "Queries tm.user_places to match coordinates to labeled places using ST_DWithin",
        "Returns array of { start, end, place_id, place_label, latitude, longitude, confidence }",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Function added to apps/mobile/src/lib/supabase/services/evidence-data.ts. Includes LocationEvidence interface, fetchLocationSamplesForWindow, fetchLocationHourlyForWindow helpers, haversine distance matching, and confidence calculation based on sample count and accuracy."
    },
    {
      "id": "US-008",
      "title": "Implement location segment generation",
      "description": "As a developer, I need to convert raw location samples into contiguous place blocks.",
      "acceptanceCriteria": [
        "New function generateLocationSegments(locationSamples, userPlaces) in actual-ingestion.ts",
        "Group samples by place using user_places radius matching (default 150m)",
        "Create contiguous blocks where 70%+ of samples match a single place",
        "Each segment has deterministic source_id: location:{windowStartMs}:{placeId}:{segmentStartMs}",
        "Segments have meta.kind = 'location_block', meta.place_id, meta.place_label",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Function created in apps/mobile/src/lib/supabase/services/actual-ingestion.ts. Includes generateLocationSegments, mergeAdjacentSegments, segmentsToDerivedEvents. Uses 150m default radius, 70% place match threshold, and deterministic source_id format."
    },
    {
      "id": "US-009",
      "title": "Implement commute detection",
      "description": "As a developer, I need to detect when the user is traveling between places.",
      "acceptanceCriteria": [
        "Add function detectCommute(locationSamples, startTime, endTime) that identifies movement",
        "Commute = location changing between places without stable position for duration",
        "If commute >= 10 minutes, create Commute segment with meta.intent = 'commute'",
        "If commute < 10 minutes, add meta.travel_annotation = 'Traveled X min to [Place]' on next segment",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Functions added to actual-ingestion.ts: detectCommute, createCommuteSegment, applyTravelAnnotations, processSegmentsWithCommutes, isMovementGroup, calculatePathDistance, findBoundaryPlaces. Movement detection uses 200m min distance and 2+ unique places. Long commutes (>=10min) get own segment with meta.kind='commute' and meta.intent='commute'. Short commutes add meta.travel_annotation to next segment."
    },
    {
      "id": "US-010",
      "title": "Implement trailing edge extension for location",
      "description": "As a developer, I need continuous location at the same place to extend rather than create duplicates.",
      "acceptanceCriteria": [
        "Add function findExtendableLocationEvent(userId, windowStart, placeId)",
        "If same place_id continues from previous window, extend scheduled_end",
        "Only extend the single most recent location event",
        "Unit test: staying at office across windows creates one 'At Office' event",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Functions added to event-reconciliation.ts: findExtendableLocationEvent, canExtendLocationEvent, computeReconciliationOpsWithLocationExtension. Helpers: getPlaceId, isLocationEvent. 19 new unit tests (48 total). Extension works for same place_id (including null for unknown locations) with 60s gap threshold."
    },
    {
      "id": "US-011",
      "title": "Integrate location into reconciliation priority",
      "description": "As a developer, I need location evidence to fill gaps between screen-time events.",
      "acceptanceCriteria": [
        "Update reconciliation priority order: Protected > Screen-time > Location > Unknown",
        "Screen-time events take precedence over location blocks",
        "Location blocks fill gaps where no screen-time exists",
        "When screen-time occurs during commute, keep both (commute block with screen-time inside)",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Functions added to event-reconciliation.ts: getEventPriority, getDerivedEventPriority, trimEventToGaps, computeReconciliationOpsWithPriority. Priority order: protected (4) > screen_time (3) > location (2) > unknown (1). Commute blocks not trimmed (kept alongside screen-time). Location blocks trimmed to fill gaps. 25 new unit tests (73 total)."
    },
    {
      "id": "US-012",
      "title": "Create default app category mapping",
      "description": "As a developer, I need a hardcoded mapping of apps to categories for intent classification.",
      "acceptanceCriteria": [
        "Create constants file with DEFAULT_APP_CATEGORIES object",
        "Work apps: Slack, Google Docs, Gmail, Google Meet, Zoom, Calendar, Figma, Notion, Linear, VS Code",
        "Social apps: Instagram, TikTok, X/Twitter, Reddit, Facebook, Snapchat, LinkedIn",
        "Entertainment apps: YouTube, Netflix, Spotify, Apple Music, Twitch, Disney+, Podcasts",
        "Comms apps: Messages, WhatsApp, Telegram, Signal, Phone, FaceTime",
        "Utility apps: Maps, Photos, Weather, Calculator, Settings, Files, Notes",
        "Export function getAppCategory(appId, userOverrides) that checks user overrides first",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Created apps/mobile/src/lib/supabase/services/app-categories.ts. Exports: AppCategory type (work/social/entertainment/comms/utility/ignore), DEFAULT_APP_CATEGORIES (100+ apps mapped), getAppCategory(appId, userOverrides) with exact + partial matching and user override priority. Helpers: isWorkCategory, isLeisureCategory, getAppsByCategory."
    },
    {
      "id": "US-013",
      "title": "Implement intent classification algorithm",
      "description": "As a developer, I need to classify sessions as Work, Leisure, or Distracted Work based on app usage.",
      "acceptanceCriteria": [
        "New function classifyIntent(screenTimeSummary: AppSummary[]) returns Intent",
        "If Work >= 60% of screen-time, return 'work'",
        "If Social + Entertainment >= 60%, return 'leisure'",
        "If Work 40-60% AND Social >= 25%, return 'distracted_work'",
        "If no screen-time, return 'offline'",
        "Otherwise return 'mixed'",
        "Unit tests cover all classification rules",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Function added to apps/mobile/src/lib/supabase/services/app-categories.ts. Exports: Intent type, AppSummary interface, IntentClassificationResult interface, INTENT_THRESHOLDS constants, classifyIntent(screenTimeSummary, userOverrides), classifyIntentSimple(screenTimeSummary, userOverrides). 31 unit tests in app-categories.test.ts covering all classification rules."
    },
    {
      "id": "US-014",
      "title": "Implement sessionization pass - grouping by location",
      "description": "As a developer, I need to group granular events into place-anchored session blocks.",
      "acceptanceCriteria": [
        "New function sessionizeWindow(userId, windowStart, windowEnd) in actual-ingestion.ts",
        "Groups events by location (place changes = session boundary)",
        "Creates session blocks with meta.kind = 'session_block'",
        "Links child events via meta.children array of event IDs",
        "Session title format: '[Place] - [Intent]' (e.g., 'Cafe - Work')",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Function added to apps/mobile/src/lib/supabase/services/actual-ingestion.ts. Exports: SessionBlock interface, SessionizableEvent interface, sessionizeWindow function, sessionBlockToDerivedEvent helper. Groups events by location with place_id changes creating session boundaries. Commute events form their own sessions. Session title format '[Place] - [Intent]' with intent from classifyIntent()."
    },
    {
      "id": "US-015",
      "title": "Implement micro-gap merging in sessionization",
      "description": "As a developer, I need small gaps (<5 min) merged into adjacent sessions.",
      "acceptanceCriteria": [
        "Update sessionizeWindow to merge gaps < 5 minutes into adjacent sessions",
        "Absorb short gaps into the preceding session block",
        "Only create session blocks >= 10 minutes duration",
        "Shorter sessions absorbed into neighbors",
        "Unit test: 3-minute gap between events at same place gets merged",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Functions added to actual-ingestion.ts: mergeSessionMicroGaps (merges sessions with gaps < 5 min at same place), absorbShortSessions (absorbs sessions < 10 min into adjacent neighbors), mergeSessionBlocks (combines two sessions), combineAppSummaries (for re-classification), isSessionCommute (helper). Updated sessionizeWindow to apply micro-gap merging and short session absorption after initial grouping. Constants: MAX_MICRO_GAP_MS (5 min), MIN_SESSION_DURATION_MS (10 min). 19 unit tests in actual-ingestion.test.ts."
    },
    {
      "id": "US-016",
      "title": "Add session summary generation",
      "description": "As a developer, I need session blocks to include a summary of top apps used.",
      "acceptanceCriteria": [
        "Add meta.summary to session blocks: array of { label: string, seconds: number }",
        "Summary contains top 3 apps by duration within the session",
        "Calculate summary from child events' app usage",
        "Store meta.intent based on classifyIntent() result",
        "Store meta.confidence from location data confidence",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Already implemented in createSessionBlock (US-014). SessionBlock interface includes meta.summary (line 1006), meta.intent (line 1002), meta.confidence (line 1004). buildAppSummary (lines 1120-1139) aggregates screen-time by app_id from child events. createSessionBlock (lines 1281-1284) creates top 3 summary. Tests in actual-ingestion.test.ts verify summary combining when merging sessions."
    },
    {
      "id": "US-017",
      "title": "Implement sleep session detection",
      "description": "As a developer, I need overnight gaps at home to become Sleep session blocks.",
      "acceptanceCriteria": [
        "Detect overnight gap at home (cross-reference with user's scheduled sleep time if available)",
        "Create 'Home - Sleep' session block for sleep period",
        "Session has meta.intent = 'sleep'",
        "If screen-time detected during scheduled sleep: split into Sleep -> Screen-time -> Sleep",
        "Screen-time block during sleep has meta.during_scheduled_sleep = true",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Functions added to actual-ingestion.ts: isHomePlace, isWithinSleepSchedule, createSleepSession, detectSleepSessions, applySleepDetection, findHomePlace. Added SleepSchedule interface, DEFAULT_SLEEP_SCHEDULE constant, SleepDetectionResult type. Added 'sleep' to Intent type. Added during_scheduled_sleep to SessionBlock.meta. 19 new unit tests (38 total in actual-ingestion.test.ts)."
    },
    {
      "id": "US-018",
      "title": "Update ingestion hook for new pipeline",
      "description": "As a developer, I need the useActualIngestion hook to use the new immutable pipeline.",
      "acceptanceCriteria": [
        "Update useActualIngestion hook to: 1) Check if window is locked, 2) Fetch screen-time + location evidence, 3) Run reconciliation with new priority, 4) Run sessionization pass, 5) Lock the window, 6) Update checkpoint",
        "Graceful error handling (non-fatal, retry on next trigger)",
        "Log stats for debugging (events created, extended, sessionized)",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Created apps/mobile/src/lib/supabase/hooks/use-actual-ingestion.ts. Exports useActualIngestion hook with processWindow, processWindows, getCurrentWindow, getPreviousWindow functions. Implements full pipeline: 1) isWindowLocked check, 2) Parallel fetch of screentime/location/userPlaces/overrides/existingEvents/extensionCandidates, 3) computeReconciliationOpsWithPriority, 4) sessionizeWindow + applySleepDetection, 5) lockEventsInWindow + lockWindow. Graceful error handling with non-fatal failures for locks. Stats logging in dev mode."
    },
    {
      "id": "US-019",
      "title": "Update calendar display to show session blocks",
      "description": "As a developer, I need the actual calendar to display session blocks by default.",
      "acceptanceCriteria": [
        "Update actual-display-events.ts to filter for meta.kind = 'session_block'",
        "Hide child events (granular events) in default view",
        "Session block display shows: title, subtitle with top 3 apps, location icon",
        "Color coding based on intent: work=blue, leisure=green, distracted=orange, sleep=purple, commute=gray",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Updated actual-display-events.ts to filter session_block events and hide child events. Added intent-based color coding to ComprehensiveCalendarTemplate.tsx. Extended CalendarEventMeta type with session block fields (kind: session_block/location_block/commute, place_id, place_label, intent, children, summary, etc.). TimeEventBlock shows location icon (MapPin), title, and session subtitle with top 3 apps."
    },
    {
      "id": "US-020",
      "title": "Add session detail view with classification reasoning",
      "description": "As a user, I want to tap a session block and see why it was classified that way.",
      "acceptanceCriteria": [
        "Tapping session block opens detail view/modal",
        "Shows classification reasoning: 'Classified as Work because: Slack 45%, Docs 30%, Gmail 15%'",
        "Shows breakdown of app usage within session (all apps, not just top 3)",
        "Shows location confidence indicator",
        "Shows time range of session",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Implement session split functionality",
      "description": "As a user, I want to split a session into two if it combined things I consider separate.",
      "acceptanceCriteria": [
        "'Split' action available in session detail view",
        "User can select split point via time picker",
        "Creates two new session blocks, original marked as soft-deleted",
        "New blocks have meta.source = 'user' (protected from future ingestion)",
        "Child events redistributed to appropriate new parent based on time",
        "Recalculate intent for each new block",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Implement session merge functionality",
      "description": "As a user, I want to merge adjacent sessions if they represent one activity.",
      "acceptanceCriteria": [
        "'Merge' action available in session detail view",
        "Shows list of mergeable neighbors (adjacent sessions)",
        "Creates single session block spanning both time ranges",
        "Combined children from both original sessions",
        "Recalculates intent based on combined app usage",
        "New block has meta.source = 'user' (protected)",
        "Original blocks soft-deleted",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Implement add place functionality",
      "description": "As a user, I want to label places so future visits are recognized automatically.",
      "acceptanceCriteria": [
        "'Add Place' action when viewing session at unknown location",
        "User provides label (Home, Office, Gym, or custom text)",
        "Saves to tm.user_places with current coordinates and 150m default radius",
        "Future location samples within radius auto-match to this place",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Add places management in settings",
      "description": "As a user, I want to view, edit, and delete my saved places.",
      "acceptanceCriteria": [
        "Settings screen includes 'My Places' section",
        "Lists all user places with label and optional category",
        "Edit action allows changing label and radius",
        "Delete action removes place (with confirmation)",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Implement Google Places auto-suggest",
      "description": "As a user, I want the app to suggest place names when I'm somewhere new.",
      "acceptanceCriteria": [
        "When location doesn't match user_places, query Google Places API for nearby POIs",
        "Show suggestion prompt: 'Are you at Starbucks?' with Accept/Reject buttons",
        "If accepted, save to user_places with Google Place metadata",
        "If rejected, prompt for manual label or use 'Near [Area]' as fallback",
        "Cache Google Places responses (15-min TTL) to reduce API calls",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Add app category overrides settings",
      "description": "As a user, I want to recategorize apps if the defaults don't match my usage.",
      "acceptanceCriteria": [
        "Settings screen includes 'App Categories' section",
        "Shows apps used in last 30 days with current category",
        "User can change category via dropdown: Work, Social, Entertainment, Comms, Utility, Ignore",
        "Overrides saved to tm.user_app_categories table",
        "getAppCategory() function checks user overrides before defaults",
        "Typecheck passes",
        "Verify in browser/simulator"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Handle location permission denied gracefully",
      "description": "As a user, I want the app to work without location but remind me of the benefits.",
      "acceptanceCriteria": [
        "If location permission denied: fall back to screen-time only ingestion",
        "Gaps filled with 'Unknown' instead of place blocks (existing behavior)",
        "Show periodic prompt (max 1x per week): 'Enable location for better insights'",
        "Prompt explains value and has buttons: 'Go to Settings', 'Not now'",
        "Track last prompt date to enforce weekly limit",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Implement fuzzy location labels for low confidence",
      "description": "As a developer, I need to show approximate location when confidence is low.",
      "acceptanceCriteria": [
        "When location confidence < 70%, use fuzzy label instead of place name",
        "Fuzzy label format: 'Near [City/Area]' using reverse geocoding",
        "Store meta.fuzzy_location = true on these blocks",
        "UI shows different styling for fuzzy locations (e.g., dashed border or ? icon)",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    }
  ]
}
