# Ralph Progress Log
Started: Sun Feb  1 22:23:14 CST 2026

## Codebase Patterns
- Migration files use naming convention `YYYYMMDD_description.sql` in `supabase/migrations/`
- Always use `IF NOT EXISTS` for tables, indexes, and RLS policy creation (idempotent migrations)
- RLS policies follow pattern: `tablename_select_own`, `tablename_insert_own`, etc.
- Use `do $$ begin...end $$` blocks for conditional policy creation
- Reference `auth.users(id)` with `ON DELETE CASCADE` for user_id foreign keys
- Foreign keys to `tm.user_places(id)` should use `ON DELETE SET NULL` (places can be deleted)
- Grant permissions at end: `grant select, insert, update, delete on tm.tablename to authenticated;`
- Check constraints on numeric fields (e.g., confidence scores between 0 and 1)
- JSONB columns should have default empty object/array: `default '{}'::jsonb` or `default '[]'::jsonb`

---

## Sun Feb 1 22:45:00 CST 2026 - DP-001
- **Implemented:** Created `tm.activity_segments` table migration for BRAVO layer
- **Files changed:**
  - `supabase/migrations/20260201_create_tm_activity_segments.sql` (new file)
  - `.ralph/prd.json` (marked DP-001 as passes: true)
- **Acceptance Criteria Met:**
  - ✅ Migration file created in supabase/migrations/
  - ✅ Table has all columns from plan (id, user_id, started_at, ended_at, hour_bucket, place_id, place_label, place_category, location_lat, location_lng, inferred_activity, activity_confidence, top_apps, total_screen_seconds, evidence, source_ids, created_at, updated_at)
  - ✅ Indexes created: idx_activity_segments_user_hour, idx_activity_segments_place, idx_activity_segments_user_time
  - ✅ RLS policies for select, insert, update, delete (users can only access own data)
  - ✅ Lint check passes (no errors)
- **Learnings for future iterations:**
  - Local Supabase database is not running, so can't test migrations locally with `supabase db lint`
  - Pre-existing TypeScript errors exist in the codebase (unrelated to migrations)
  - Migrations don't need TypeScript compilation - they're pure SQL
  - Use `pnpm run lint` to verify no new errors introduced
  - `tm.user_places` table is defined in `20260112_create_tm_location_samples.sql`
---

## Sun Feb 1 23:05:00 CST 2026 - DP-002
- **Implemented:** Created `tm.hourly_summaries` table migration for CHARLIE layer
- **Files changed:**
  - `supabase/migrations/20260201_create_tm_hourly_summaries.sql` (new file)
  - `.ralph/prd.json` (marked DP-002 as passes: true)
- **Acceptance Criteria Met:**
  - ✅ Migration file created in supabase/migrations/
  - ✅ Table has all columns from plan including user_feedback, user_edits, locked_at, ai_generated
  - ✅ Unique constraint on (user_id, hour_start) via `constraint hourly_summaries_user_hour_unique`
  - ✅ Indexes created: idx_hourly_summaries_user_date, idx_hourly_summaries_unlocked (partial), idx_hourly_summaries_user_hour
  - ✅ RLS policies for select, insert, update, delete (users can only access own data)
  - ✅ Lint check passes (no new errors)
- **Learnings for future iterations:**
  - Partial indexes use `where` clause (e.g., `where locked_at is null` for unlocked summaries)
  - Unique constraints use `constraint` keyword in table definition rather than separate statement
  - CHARLIE layer tables need more columns for user interaction (feedback, edits, locking)
---
