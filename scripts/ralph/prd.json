{
  "project": "TodayMatters Mobile",
  "branchName": "ralph/v2-android-location-fixes",
  "description": "Android Location Tracking Reliability & Movement Detection - Fix critical location tracking failures and implement adaptive sampling",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add Android 14+ detection and manifest updates",
      "description": "As a developer, I need to detect Android 14+ and update AndroidManifest.xml with required permissions and service types so the app can request location permissions properly on newer Android versions.",
      "acceptanceCriteria": [
        "Add Platform.Version check utility to detect Android API level 34+",
        "Update AndroidManifest.xml with FOREGROUND_SERVICE_LOCATION permission",
        "Update AndroidManifest.xml foreground service type to include 'location'",
        "Add ACTIVITY_RECOGNITION permission to manifest (for future use)",
        "Export isAndroid14Plus() helper from android-location utils",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "FOREGROUND_SERVICE_LOCATION and foregroundServiceType already present via expo-location manifest merger. Added ACTIVITY_RECOGNITION to manifest and app.config.js."
    },
    {
      "id": "US-002",
      "title": "Add error logging infrastructure to AsyncStorage",
      "description": "As a developer, I need a centralized error logging system that persists to AsyncStorage so I can diagnose location tracking failures.",
      "acceptanceCriteria": [
        "Create ErrorLogger class in android-location/error-logger.ts",
        "Implement logError(category, message, context) method",
        "Store errors as circular buffer (max 50 entries, FIFO)",
        "Error format: { timestamp, category, message, context, count }",
        "Implement getRecentErrors() to retrieve last 50 errors",
        "Throttle duplicate errors (same category+message within 5 mins = increment count)",
        "Error categories enum: PERMISSION_DENIED, TASK_START_FAILED, TASK_EXECUTION_FAILED, LOCATION_UNAVAILABLE, SYNC_FAILED",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created error-logger.ts with ErrorCategory enum, logError() with circular buffer (max 50) and 5-min duplicate throttling, getRecentErrors(), clearErrors(). Exported from index.ts barrel."
    },
    {
      "id": "US-003",
      "title": "Integrate error logging into existing location code",
      "description": "As a developer, I need all location tracking error paths to log to AsyncStorage so failures are captured for diagnostics.",
      "acceptanceCriteria": [
        "Add error logging to location-task.ts on all error/early-return paths",
        "Add error logging to index.ts startTracking() failures",
        "Add error logging to permissions.ts permission denial paths",
        "Add error logging to queue.ts sync failures",
        "Include context: permission status, task status, last sample timestamp, Android version",
        "All logs use ErrorLogger.logError() with appropriate category",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added logError() calls to: location-task.ts (4 error paths: task error callback, empty locations, no user session, all samples invalid, catch block), index.ts (permission check/request failures, startAndroidBackgroundLocationAsync early returns for no module/no services/fg denied/bg denied/start exception, flush sync failure), use-location-samples-sync.ts (start tracking failure, flush failure). All logs include androidApiLevel context. No separate permissions.ts exists - permission logic is in index.ts. Queue.ts has no direct error paths (called by task/flush)."
    },
    {
      "id": "US-004",
      "title": "Update location task configuration for 15-minute intervals",
      "description": "As a user, I need location samples captured every 15 minutes so my daily activity is comprehensively tracked.",
      "acceptanceCriteria": [
        "Update startLocationUpdatesAsync options to include timeInterval: 900000 (15 minutes)",
        "Update deferredUpdatesInterval to 900000 to match timeInterval",
        "Verify showsBackgroundLocationIndicator is true",
        "Verify foregroundService notification title/body are clear",
        "Add AsyncStorage tracking for last task execution timestamp",
        "Log task execution to AsyncStorage on every location-task.ts callback",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Updated timeInterval and deferredUpdatesInterval to 900000ms (15 min). Added showsBackgroundLocationIndicator: true. Created task-heartbeat.ts with recordTaskHeartbeat()/getLastTaskHeartbeat() for AsyncStorage persistence (key: tm:location:lastTaskExecution). Heartbeat recorded on every location-task.ts callback (initial 0, updated to actual sample count on success). Exported from barrel index.ts."
    },
    {
      "id": "US-005",
      "title": "Implement distance calculation utility",
      "description": "As a developer, I need haversine distance calculation between coordinates so I can detect user movement.",
      "acceptanceCriteria": [
        "Create calculateDistance(coord1, coord2) function in android-location/distance.ts",
        "Use haversine formula for accurate distance calculation",
        "Input: { latitude, longitude } objects",
        "Output: distance in meters",
        "Unit tests with known coordinate pairs and expected distances",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Created distance.ts with Coordinate interface and calculateDistance() using haversine formula. Returns distance in meters. 9 unit tests covering: identical points, long distances (NYC-LA, London-Paris), short walking distances, equator crossing, antimeridian crossing, symmetry, GPS drift, and pole-to-pole. Exported calculateDistance and Coordinate type from barrel index.ts."
    },
    {
      "id": "US-006",
      "title": "Add movement state management to AsyncStorage",
      "description": "As a developer, I need to persist movement state (moving/stationary) to AsyncStorage so it survives app restarts.",
      "acceptanceCriteria": [
        "Create MovementState type: 'moving' | 'stationary' | 'unknown'",
        "Implement getMovementState() to read from AsyncStorage key tm:location:movementState",
        "Implement setMovementState(state) to write to AsyncStorage",
        "Store metadata: state, lastUpdated timestamp, reason (activity or distance)",
        "Default to 'unknown' if no state exists",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Created movement-state.ts with MovementState type ('moving'|'stationary'|'unknown'), MovementReason type ('activity'|'distance'), and MovementStateData interface (state, lastUpdated, reason). Implemented getMovementState() and setMovementState() with AsyncStorage persistence (key: tm:location:movementState). Defaults to 'unknown' state when nothing stored. Includes runtime type guard for safe deserialization. Exported from barrel index.ts."
    },
    {
      "id": "US-007",
      "title": "Implement distance-based movement detection",
      "description": "As a user on devices without activity recognition, I need distance-based movement detection so tracking frequency adapts to my activity.",
      "acceptanceCriteria": [
        "Create classifyMovementByDistance() in android-location/movement-detector.ts",
        "Calculate distance between last 3 consecutive location samples",
        "If total distance >200 meters over samples spanning 15+ mins, classify as 'moving'",
        "If total distance <50 meters over samples spanning 30+ mins, classify as 'stationary'",
        "Filter out low-accuracy samples (accuracy >50m) before calculation",
        "Ignore tiny movements (<10m) to handle GPS drift",
        "Return classification with confidence score",
        "Unit tests with various sample sequences",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Created movement-detector.ts with classifyMovementByDistance(). Filters samples by accuracy (<=50m), sorts chronologically, sums consecutive distances ignoring GPS drift (<10m). Moving: >200m over >=15min. Stationary: <50m over >=30min. Confidence ranges 0.7-1.0 based on distance/time ratios. Returns null state for ambiguous or insufficient data (<3 usable samples). 17 unit tests covering: empty/insufficient data, accuracy filtering, moving/stationary classification, GPS drift, ambiguous zones, non-chronological input, edge cases, mixed accuracy samples. Exported from barrel index.ts."
    },
    {
      "id": "US-008",
      "title": "Integrate movement detection into location task",
      "description": "As a user, I want my movement state automatically updated based on location samples so tracking frequency can adapt.",
      "acceptanceCriteria": [
        "Call classifyMovementByDistance() on every location sample in location-task.ts",
        "Update movement state to AsyncStorage when classification changes",
        "Log movement state changes to AsyncStorage for diagnostics",
        "Store last 10 location samples in memory for classification (cleared on task restart)",
        "Only update state if confidence >70%",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Integrated movement detection into location-task.ts. Added in-memory buffer (max 10 samples) that accumulates validated samples on each task callback. After enqueuing samples, calls classifyMovementByDistance() on the buffer. Only updates persisted movement state (via setMovementState) when confidence >= 0.7 and state differs from current. Movement state changes logged via setMovementState() which persists to AsyncStorage (tm:location:movementState). Buffer clears naturally on task/process restart since it's module-level."
    },
    {
      "id": "US-009",
      "title": "Implement adaptive sync intervals based on movement state",
      "description": "As a user, I need location data synced efficiently based on my movement so I don't drain battery unnecessarily.",
      "acceptanceCriteria": [
        "Update use-location-samples-sync.ts to read movement state from AsyncStorage",
        "When stationary: sync every 30 minutes OR when 10 samples queued (whichever first)",
        "When moving: sync every 15 minutes OR when 20 samples queued (whichever first)",
        "When unknown: use moving intervals (conservative approach)",
        "On app foreground: immediate sync regardless of interval",
        "Add lastSyncTime to AsyncStorage to track sync timing",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Split use-location-samples-sync.ts into separate iOS (fixed 2-min interval) and Android (adaptive) sync effects. Android sync uses two mechanisms: (1) time-based intervals that adapt to movement state (30 min stationary, 15 min moving/unknown), and (2) queue-size polling every 60s that triggers sync when pending samples exceed threshold (10 stationary, 20 moving/unknown). App foreground triggers immediate sync via AppState listener. Created sync-timing.ts with recordLastSyncTime()/getLastSyncTime() for AsyncStorage persistence (key: tm:location:lastSyncTime). Exported peekPendingAndroidLocationSamplesAsync and sync-timing functions from barrel index.ts."
    },
    {
      "id": "US-010",
      "title": "Enhanced health check with movement-aware intervals",
      "description": "As a user, if location tracking stops working, I need the health check to detect it quickly and attempt recovery.",
      "acceptanceCriteria": [
        "Update health check in use-location-samples-sync.ts to read movement state",
        "Check if last sample timestamp is within expected interval (15 mins stationary, 5 mins moving)",
        "Verify background task is still registered and started",
        "Verify location permissions still granted",
        "If checks fail: attempt automatic task restart (max 3 times, exponential backoff 30s, 2min, 5min)",
        "Track retry count in AsyncStorage (tm:androidLocation:healthCheckRetries)",
        "Reset retry count when task successfully restarts or app comes to foreground",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Add persistent notification after health check failures",
      "description": "As a user, after automatic recovery fails 3 times, I need a notification alerting me so I can take action.",
      "acceptanceCriteria": [
        "After 3 failed health check restarts, show persistent notification",
        "Notification title: 'Location tracking paused'",
        "Notification body: 'Tap to fix the issue and resume tracking'",
        "Notification uses location pin icon with warning badge",
        "Notification deep-links to diagnostics screen (using Expo Notifications)",
        "Notification priority: DEFAULT (not intrusive)",
        "Notification persists until user taps or tracking restored",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create enhanced diagnostics data structure",
      "description": "As a developer, I need to collect comprehensive diagnostic data from all location subsystems so it can be displayed or exported.",
      "acceptanceCriteria": [
        "Create getDiagnostics() function in android-location/diagnostics.ts",
        "Section 1: System info (Android version, device model, app version)",
        "Section 2: Permission status (foreground, background, battery optimization)",
        "Section 3: Task status (registered, started, last fired, consecutive failures)",
        "Section 4: Location data (samples today, last sample, queue size, sync status)",
        "Section 5: Movement state (current classification, last update, confidence)",
        "Section 6: Health check (last check time, retry count, blocking errors)",
        "Section 7: Recent errors (last 10 from ErrorLogger)",
        "Return as structured JSON object",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Update diagnostics screen UI with enhanced data",
      "description": "As a user or support agent, I need to see detailed diagnostic information to troubleshoot location tracking issues quickly.",
      "acceptanceCriteria": [
        "Update existing diagnostics screen (dev/location.tsx or profile.tsx) to call getDiagnostics()",
        "Display all 7 diagnostic sections in collapsible accordions",
        "Color-code status indicators (green=good, yellow=warning, red=error)",
        "Use monospace font for technical details (timestamps, coordinates)",
        "Auto-refresh every 5 seconds while screen is open",
        "Show loading spinner during refresh",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add diagnostic action buttons (Export, Force Restart, Test)",
      "description": "As a user, I need action buttons on the diagnostics screen to export data, manually restart tracking, or test location immediately.",
      "acceptanceCriteria": [
        "Add 'Export Diagnostics' button that copies full diagnostics JSON to clipboard",
        "Show toast confirmation after export",
        "Add 'Force Restart Task' button that calls stopAndroidLocationTracking() then startAndroidLocationTracking()",
        "Show loading state during restart, then success/failure message",
        "Add 'Test Location Now' button that requests single location immediately",
        "Display test result (coordinates, accuracy, timestamp) or error message",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create guided permission setup flow component",
      "description": "As a user, I need a step-by-step permission setup flow that verifies each requirement so I know location tracking will work reliably.",
      "acceptanceCriteria": [
        "Create PermissionSetupFlow component in permissions/setup-flow.tsx",
        "Use stepper UI with 6 steps (configurable based on Android version)",
        "Step 1: Request foreground location permission, verify granted",
        "Step 2: Request background location permission (Android 10+), verify granted",
        "Step 3: Check location services enabled, button to open system settings if disabled",
        "Step 4: Check battery optimization, button to open battery settings if enabled",
        "Step 5 (Android 14+ only): Guide to 'Allow all the time' in Settings with screenshots",
        "Step 6: Start background task, verify started successfully",
        "Each step shows status: pending (gray), in-progress (blue), complete (green), failed (red)",
        "Progress saved to AsyncStorage, can resume if user exits",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Add deep-links to Android Settings screens",
      "description": "As a user, I need 'Open Settings' buttons to take me directly to the correct Android settings screen so I don't have to navigate manually.",
      "acceptanceCriteria": [
        "Create openLocationSettings() helper using Linking.openSettings() for location services",
        "Create openBatteryOptimizationSettings() using IntentLauncher for battery settings",
        "Create openAppSettings() using Linking.openSettings() for app-specific settings",
        "Add Android 14+ specific guidance modal with screenshots when 'Allow all the time' step needed",
        "Verify deep-links work on Android 10, 12, 14+ test devices",
        "Fallback to generic app settings if specific intent fails",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Add movement state visualization to Location Activity screen",
      "description": "As a user, I want to see my current movement state and how it affects tracking frequency so I understand the system behavior.",
      "acceptanceCriteria": [
        "Update Location Activity screen to show current movement state at top",
        "Visual indicator: green icon + 'Moving' or gray icon + 'Stationary'",
        "Show current sampling interval: '5 minutes' or '15 minutes'",
        "Show last state change timestamp",
        "Add info tooltip explaining why frequency changes based on movement",
        "Update in real-time when screen is open (subscribe to movement state changes)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Add in-app banner for tracking failures",
      "description": "As a user, when location tracking stops, I need a visible banner on the home screen so I know to fix it.",
      "acceptanceCriteria": [
        "Create LocationTrackingBanner component",
        "Show banner at top of home screen when task status is 'stopped' or health check has 3+ failures",
        "Yellow background with warning icon",
        "Message: 'Location tracking is paused'",
        "Action button: 'Fix Now' opens diagnostics screen",
        "Banner dismissible (hide for 1 hour), reappears if still broken",
        "Store dismiss timestamp in AsyncStorage",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Create guided recovery flow for common errors",
      "description": "As a user who encounters a tracking failure, I need step-by-step guidance to fix the issue without technical knowledge.",
      "acceptanceCriteria": [
        "Create RecoveryFlow component that takes error category as prop",
        "Error PERMISSION_DENIED: Show permission setup flow starting at appropriate step",
        "Error TASK_START_FAILED: Show checklist (permissions, battery, location services) with test buttons",
        "Error LOCATION_UNAVAILABLE: Show tutorial to enable location services with screenshots",
        "Error on Android 14: Show specific Android 14 setup guide",
        "Each flow includes 'Test Now' button to verify fix worked",
        "Show success confirmation when test passes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Integrate recovery flows into diagnostics screen",
      "description": "As a user on the diagnostics screen, I need quick access to recovery flows for detected errors.",
      "acceptanceCriteria": [
        "Add 'Fix This Issue' button next to each detected error in diagnostics",
        "Button opens RecoveryFlow component for that specific error category",
        "Button disabled if no actionable recovery flow exists for error type",
        "After completing recovery flow, re-run diagnostics and update display",
        "Show success toast if error resolved",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Update existing permissions.tsx to use new setup flow",
      "description": "As a user going through initial app setup, I need to use the new guided permission setup flow instead of the old simple permission requests.",
      "acceptanceCriteria": [
        "Replace existing permission request logic in permissions.tsx with PermissionSetupFlow component",
        "Maintain backward compatibility with existing navigation flow",
        "On successful completion, navigate to next onboarding step",
        "On cancellation, show warning about reduced functionality",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Add 24-hour movement timeline visualization",
      "description": "As a user, I want to see a timeline of my movement state changes over the past 24 hours so I can verify the system is detecting movement correctly.",
      "acceptanceCriteria": [
        "Create mini-timeline component showing past 24 hours",
        "Divide timeline into hourly segments",
        "Color-code segments: green=moving, gray=stationary, white=unknown/no data",
        "Tap segment to show details (time range, sample count, avg accuracy)",
        "Show movement state changes as markers on timeline",
        "Updates in real-time as new samples arrive",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Integrate timeline into Location Activity screen",
      "description": "As a user viewing my location activity, I want the movement timeline visible so I can understand my activity patterns.",
      "acceptanceCriteria": [
        "Add movement timeline below current movement state indicator on Location Activity screen",
        "Timeline takes full width, horizontally scrollable if needed",
        "Position between header and hourly activity chart",
        "Add section title 'Movement History (24h)'",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    }
  ]
}
