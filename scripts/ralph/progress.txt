# Ralph Progress Log
Started: Thu Jan 22 14:33:52 CST 2026
Updated: Sun Jan 26 2026 - New PRD: V2 Bugs and Features
---

## Codebase Patterns
- Evidence data is fetched in `apps/mobile/src/lib/supabase/services/evidence-data.ts`
- Actual event derivation happens in `apps/mobile/src/lib/calendar/actual-display-events.ts`
- Screen time derivation is in `apps/mobile/src/lib/calendar/derive-screen-time-actual-events.ts`
- Calendar orchestration is in `apps/mobile/src/app/comprehensive-calendar.tsx`
- Rendering with absolute positioning is in `apps/mobile/src/components/templates/ComprehensiveCalendarTemplate.tsx`
- Known duplicate key issue at ComprehensiveCalendarTemplate.tsx lines 552-559
- Android location code lives in `apps/mobile/src/lib/android-location/` — index.ts (start/stop/diagnostics), location-task.ts (background task handler), queue.ts (AsyncStorage sample buffer), register.ts (one-time task registration)
- Android location background task uses expo-location + expo-task-manager; task must be defined at module scope per Expo docs
- Location samples are buffered in AsyncStorage (key: `tm:location:pending:{userId}`) then flushed to Supabase via `flushPendingAndroidLocationSamplesToSupabaseAsync()`
- Pre-existing TS errors exist in the codebase (42 total as of Jan 26 2026) — do not block on these; verify your changes don't add new ones

## Critical Issue - Android Physical Device
- **Problem**: Evidence data (location, screen time) not pulling on physical Android devices
- **Works**: Android simulator
- **Fails**: Physical Android device via Play Console internal testing (production build)
- **Permissions**: All granted (Usage Access, Location)
- **Symptom**: Nothing being pulled despite permissions granted
- **Priority**: HIGHEST - US-001 and US-002 must be completed first

---

## 2026-01-26 - US-026
- **What was implemented**: Investigated Android location canStart failure. Found and fixed a logic bug in `getAndroidLocationDiagnostics()` where canStart could NEVER be true. Added verbose diagnostic logging throughout the diagnostic function, background task callback, and profile diagnostics display. Added `lastSampleTimestamp` and `sampleCount24h` to diagnostics output.
- **Root cause found**: In `index.ts` line 251 (old code), when `taskStarted=false` and `errors.length === 0`, the code pushed an error "Task not started despite all checks passing - unknown reason". This made `errors.length > 0`, so `canStart = errors.length === 0 && !diagnostics.taskStarted` always evaluated to false. The only scenario where canStart should be true (all checks pass, task not started) was the exact scenario that added a spurious error.
- **Files changed**:
  - `apps/mobile/src/lib/android-location/index.ts` — Fixed canStart logic bug, added verbose `[diag]`-prefixed logging to each diagnostic step, added `lastSampleTimestamp` and `sampleCount24h` fields to diagnostics, added `MAX_PENDING_SAMPLES_PER_USER` constant for full sample peek
  - `apps/mobile/src/lib/android-location/location-task.ts` — Added `[task]`-prefixed logging: task fire timestamp, raw location count, conversion result, authenticated user check, queue result
  - `apps/mobile/src/app/profile.tsx` — Updated diagnostics Alert to show `canStart`, `lastSampleTimestamp`, and `sampleCount24h` fields
- **Learnings for future iterations:**
  - The canStart logic was self-contradictory: it treated "task not started despite checks passing" as an error, but that's the normal state when the app should start the task. Future logic should distinguish "informational" vs "blocking" issues.
  - Background task error logging was gated behind `__DEV__` — the catch block in defineTask only logged in dev mode. Changed the catch to always log since background task failures are critical.
  - Location task fires asynchronously by the Android system — adding timestamp logging is critical to verify it actually fires.
  - `peekPendingAndroidLocationSamplesAsync` with limit=1000 missed samples beyond that; changed to MAX_PENDING_SAMPLES_PER_USER (10000) for accurate diagnostics.
  - Pre-existing TS errors: `PermissionStatus` type mismatch at lines 46/98 — string literal `'denied'` doesn't match enum. Not blocking; don't fix in unrelated stories.
---
