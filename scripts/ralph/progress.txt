# Ralph Progress Log
Started: Thu Jan 22 14:33:52 CST 2026
Updated: Fri Jan 24 2026 - New PRD: Calendar Actual Timeline Fix
---

## Codebase Patterns
- Evidence data is fetched in `apps/mobile/src/lib/supabase/services/evidence-data.ts`
- Actual event derivation happens in `apps/mobile/src/lib/calendar/actual-display-events.ts`
- Screen time derivation is in `apps/mobile/src/lib/calendar/derive-screen-time-actual-events.ts`
- Calendar orchestration is in `apps/mobile/src/app/comprehensive-calendar.tsx`
- Rendering with absolute positioning is in `apps/mobile/src/components/templates/ComprehensiveCalendarTemplate.tsx`
- Known duplicate key issue at ComprehensiveCalendarTemplate.tsx lines 552-559
- Android native module for insights: `apps/mobile/modules/android-insights/android/src/main/java/expo/modules/androidinsights/AndroidInsightsModule.kt`
- Use `Log.d(TAG, ...)` for production logging in Kotlin (logcat tag: "AndroidInsights")
- TypeScript wrapper in `apps/mobile/modules/android-insights/src/index.ts`
- Library wrapper with safe functions in `apps/mobile/src/lib/android-insights/index.ts`
- Dev screen for Android insights at `apps/mobile/src/app/dev/android-insights.tsx`
- Pre-existing TypeScript errors in codebase - don't expect clean typecheck
- **Screen time sync**: `apps/mobile/src/lib/supabase/services/screen-time-sync.ts` - syncs iOS and Android data to Supabase
- **Insights sync hook**: `apps/mobile/src/lib/supabase/hooks/use-insights-sync.ts` - orchestrates sync on app active
- When comparing iOS vs Android sync, always check if all data fields are being synced (sessions, hourly, daily)
- **Derived Event ID Format**: Use `derived:{type}:{startMinutes}:{endMinutes}:{source}` for deterministic unique IDs
- **Screen Time Event ID Format**: Use `st:{type}:{startMinutes}:{endMinutes}:{source}` for screen time derived events
- **Overlap Resolution**: Use `buildNonOverlappingTimeline()` from `actual-timeline-builder.ts` to resolve overlaps by splitting events
- **Event Priority Order**: UserEdited(1) > SupabaseActual(2) > DerivedEvidence(3) > ScreenTime(4) > Unknown(5)

## Critical Issue - Android Physical Device
- **Problem**: Evidence data (location, screen time) not pulling on physical Android devices
- **Works**: Android simulator
- **Fails**: Physical Android device via Play Console internal testing (production build)
- **Permissions**: All granted (Usage Access, Location)
- **Symptom**: Nothing being pulled despite permissions granted
- **Priority**: HIGHEST - US-001 and US-002 must be completed first

---

## 2026-01-24 - US-001: CRITICAL: Debug Android Production Evidence Data Pull Failure
- **What was implemented:**
  - Added comprehensive production-safe logging to Android Usage Stats API calls
  - Created `getUsageStatsDiagnostics()` function in Kotlin that returns:
    - Device info (manufacturer, model, SDK version)
    - AppOps permission status with mode string
    - Usage stats counts from multiple intervals (daily, best, weekly)
    - Usage events count (foreground/background)
    - Top app with foreground time
    - Error collection
  - Exposed diagnostics through TypeScript layer (`getUsageStatsDiagnosticsAsync`)
  - Added diagnostics UI to dev/android-insights screen
  - Enhanced Android location diagnostics with detailed logging

- **Files changed:**
  - `apps/mobile/modules/android-insights/android/src/main/java/expo/modules/androidinsights/AndroidInsightsModule.kt` - Added logging, diagnostics function
  - `apps/mobile/modules/android-insights/src/index.ts` - Added TypeScript types and exports
  - `apps/mobile/src/lib/android-insights/index.ts` - Added safe wrapper function
  - `apps/mobile/src/app/dev/android-insights.tsx` - Added diagnostics UI
  - `apps/mobile/src/lib/android-location/index.ts` - Added logging to location startup and diagnostics

- **Learnings for future iterations:**
  - Use `android.util.Log` with a constant TAG for production-visible logging in Kotlin
  - Logcat tag "AndroidInsights" can be filtered on device: `adb logcat -s AndroidInsights`
  - AppOps mode values: MODE_ALLOWED=0, MODE_IGNORED=1, MODE_ERRORED=2, MODE_DEFAULT=3
  - `queryUsageStats` can return empty list even with permission if:
    1. Permission was just granted (no data collected yet)
    2. No app usage in the time range
    3. System-level issue with usage stats service
  - The codebase has many pre-existing TypeScript errors - don't expect clean typecheck

- **Next steps:**
  - Deploy to Play Console internal testing
  - Run diagnostics on physical device
  - Check logcat output for root cause
  - Implement fix based on findings (US-002)

---

## 2026-01-24 - US-002: Fix Android Production Build Evidence Collection
- **What was implemented:**
  - Added Android session syncing to `screen-time-sync.ts` - previously sessions were not being synced to Supabase
  - Added hourly data syncing for Android (matches iOS behavior)
  - Added production-safe logging throughout the sync pipeline for debugging
  - Handle null/empty usage summary gracefully with status tracking
  - Updated dev screen to show session counts and recent sessions

- **Files changed:**
  - `apps/mobile/src/lib/supabase/services/screen-time-sync.ts` - Added `mapAndroidUsageSessions()`, hourly sync, session sync, logging
  - `apps/mobile/src/lib/supabase/hooks/use-insights-sync.ts` - Added production logging, handle null summary case
  - `apps/mobile/src/app/dev/android-insights.tsx` - Show session counts and recent sessions in usage summary UI

- **Root Cause Analysis:**
  - Android sessions were not being synced to Supabase - `syncAndroidUsageSummary` was calling `await replaceAppSessions(dailyId, [])` which always cleared sessions
  - The native Kotlin module WAS producing sessions in `buildUsageHourlyBucketsSeconds()` via `queryEvents()`
  - The TypeScript `UsageSummary` type already included `sessions?: Array<{...}>`
  - The sync code just never used them

- **Learnings for future iterations:**
  - Android screen time sync was incomplete compared to iOS - always compare platform implementations
  - Silent failures in production are hard to debug - add console.log even in production for critical paths
  - The `screen_time_app_sessions` table is critical for actual timeline derivation
  - When debugging data flow issues, trace the entire pipeline from native → TypeScript → Supabase

---

## 2026-01-24 - US-003: Generate Unique Deterministic Event IDs
- **What was implemented:**
  - Created `generateDerivedId()` helper function in `actual-display-events.ts` for consistent ID format
  - Created `generateScreenTimeId()` helper function in `derive-screen-time-actual-events.ts`
  - Updated all derived event ID generation to use format: `{prefix}{type}:{startMinutes}:{endMinutes}:{source}`
  - Added uniqueness validation in `ComprehensiveCalendarTemplate.tsx` using useMemo
  - Deduplicates events before rendering with warning log when duplicates found
  - Fixes React duplicate key warnings

- **Files changed:**
  - `apps/mobile/src/lib/calendar/actual-display-events.ts` - Added helper, updated 9 ID generation points
  - `apps/mobile/src/lib/calendar/derive-screen-time-actual-events.ts` - Added helper, updated 5 ID generation points
  - `apps/mobile/src/components/templates/ComprehensiveCalendarTemplate.tsx` - Added deduplication with warning log

- **Learnings for future iterations:**
  - Event IDs should include both start AND end minutes to prevent collisions
  - Including a source identifier (app name, event ID, etc.) adds extra uniqueness
  - Pre-render validation with console.warn helps catch issues early
  - The ID format `{type}:{startMinutes}:{endMinutes}:{source}` is deterministic and debuggable
  - Codebase has 42+ pre-existing TypeScript errors - changes don't need to clear all errors, just not introduce new ones

---

## 2026-01-24 - US-004: Create ActualTimelineBuilder with Overlap Split Algorithm
- **What was implemented:**
  - Created `ActualTimelineBuilder` class in `apps/mobile/src/lib/calendar/actual-timeline-builder.ts`:
    - `EventPriority` enum with 5 priority levels
    - `getEventPriority()` function to determine event priority from metadata
    - `addEvent()` method that handles overlap by splitting events
    - `addEvents()` method for batch processing (sorted by priority)
    - `build()` method to return final non-overlapping timeline
    - `validate()` method to check for any remaining overlaps
    - `buildNonOverlappingTimeline()` convenience function
  - Priority order implemented: UserEdited(1) > SupabaseActual(2) > DerivedEvidence(3) > ScreenTime(4) > Unknown(5)
  - Split algorithm: when events overlap, lower-priority events are split around higher-priority events
  - Exported from `apps/mobile/src/lib/calendar/index.ts`
  - Integrated into `actual-display-events.ts`, replacing `removeOverlappingEvents` call

- **Files changed:**
  - `apps/mobile/src/lib/calendar/actual-timeline-builder.ts` - New file with ActualTimelineBuilder class
  - `apps/mobile/src/lib/calendar/index.ts` - Added export for actual-timeline-builder
  - `apps/mobile/src/lib/calendar/actual-display-events.ts` - Import and use buildNonOverlappingTimeline

- **Learnings for future iterations:**
  - The split approach preserves more event data than simply removing overlapping events
  - Priority detection uses metadata fields: source, kind, and ID prefixes
  - Events with `source: 'user'` or `source: 'actual_adjust'` are highest priority
  - Events with ID prefixes like `derived_actual:`, `derived_evidence:`, or `st:` indicate derived events
  - The `minDurationMinutes` parameter prevents creating tiny split segments

---

## 2026-01-24 - US-005: Add Unit Test for Overlap Elimination
- **What was implemented:**
  - Created comprehensive test file `actual-timeline-builder.test.ts` with 32 tests
  - Tests for `getEventPriority()` function covering all 5 priority levels
  - Tests for overlap resolution: two events overlapping get split into non-overlapping result
  - Tests for priority preservation: higher priority events remain intact, lower get split
  - Edge case tests: exact same time, partial overlap at start/end, contained event, adjacent events
  - Tests for invalid inputs: zero duration, negative duration events are skipped
  - Tests for `minDurationMinutes` filtering of tiny segments
  - Tests for `validate()`, `clear()`, and `eventCount` methods

- **Files changed:**
  - `apps/mobile/src/lib/calendar/actual-timeline-builder.test.ts` - New test file with 32 tests

- **Learnings for future iterations:**
  - Use `createTestEvent()` helper for creating minimal test events with required fields
  - Use `hasOverlaps()` helper to validate no two events overlap in result
  - Test priority order: UserEdited(1) > SupabaseActual(2) > DerivedEvidence(3) > ScreenTime(4) > Unknown(5)
  - Pre-existing TypeScript errors in codebase - verify new files don't add errors, not that all errors are fixed
  - Jest tests use `@/stores` path alias which works with project's jest config

---

## 2026-01-24 - US-006: Integrate ActualTimelineBuilder into Display Pipeline
- **What was implemented:**
  - Verified that `buildNonOverlappingTimeline` from `ActualTimelineBuilder` is already integrated in `buildActualDisplayEvents()` at line 446
  - Removed the unused `removeOverlappingEvents` function (61 lines of dead code) that was no longer being called
  - The integration was completed in US-004, this story cleaned up the remaining dead code
  - Verified ComprehensiveCalendarTemplate.tsx has ID-based deduplication for React key uniqueness (separate concern from time overlap)

- **Files changed:**
  - `apps/mobile/src/lib/calendar/actual-display-events.ts` - Removed unused `removeOverlappingEvents` function

- **Learnings for future iterations:**
  - The overlap handling with ActualTimelineBuilder was integrated during US-004 along with creating the class
  - ComprehensiveCalendarTemplate.tsx deduplicates by event ID (for React keys), while ActualTimelineBuilder deduplicates by time range (for visual overlap)
  - When cleaning up old code, verify nothing else uses it with grep before removing
  - Pre-existing TypeScript errors (42+) are unrelated to changes - only check for NEW errors introduced

---
