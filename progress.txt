## Codebase Patterns
- This is a Turborepo monorepo with pnpm as package manager
- Quality checks available: `pnpm run lint` and `pnpm run check-types`
- Pre-existing type errors may exist in the codebase - isolate your changes and commit only what's relevant to your story
- React Native mobile app located in /apps/mobile
- Key files for this PRD:
  - Timeline building: /apps/mobile/src/lib/calendar/actual-display-events.ts
  - Event editing: /apps/mobile/src/components/molecules/EventEditorModal.tsx
  - Actual adjust screen: /apps/mobile/src/app/actual-adjust.tsx
  - Location services: /apps/mobile/src/lib/supabase/services/location-samples.ts
  - Events store: /apps/mobile/src/stores/events-store.ts
  - Error logger: /apps/mobile/src/lib/android-location/error-logger.ts
- AsyncStorage key convention: `tm:location:<purpose>` (e.g., `tm:location:errors`, `tm:location:pending:<userId>`)
- android-location module uses barrel exports from index.ts - always re-export new modules there
- Error logging uses `logError(ErrorCategory, message, context)` - import from `@/lib/android-location`
- SafeAreaView must be imported from 'react-native-safe-area-context' not 'react-native' for proper notch/status bar handling
- Templates can either use SafeAreaView directly, useSafeAreaInsets hook with manual padding, or delegate to SetupStepLayout
- Android DateTimePicker: Use `display="default"` (native modal) not `display="spinner"` (inline) for proper state persistence
- For slide-up modals on Android, add `paddingTop: insets.top` to prevent header content from being blocked by status bar
- When parsing database timestamps, use `parseDbTimestamp()` helper (in calendar-events.ts) to ensure UTC interpretation

---

## 2026-01-22 - US-001
- What was implemented: Fixed SafeAreaView imports in 3 template files
- Files changed:
  - apps/mobile/src/components/templates/PersonalizationTemplate.tsx
  - apps/mobile/src/components/templates/AppCategoryOverridesTemplate.tsx
  - apps/mobile/src/components/templates/PatternInsightsTemplate.tsx
- **Learnings for future iterations:**
  - 3 templates were using SafeAreaView from 'react-native' (wrong) instead of 'react-native-safe-area-context' (correct)
  - Other templates either: 1) correctly import from react-native-safe-area-context, 2) use useSafeAreaInsets hook with manual padding, or 3) delegate to SetupStepLayout which handles safe areas
  - SetupStepLayout at /apps/mobile/src/components/organisms/SetupStepLayout.tsx properly wraps with SafeAreaView from react-native-safe-area-context
---

## 2026-01-22 - US-002
- What was implemented: Audited and fixed SafeAreaView usage in screen files
- Files changed:
  - apps/mobile/src/app/dev/ios-insights.tsx
  - apps/mobile/src/app/dev/android-insights.tsx
- **Learnings for future iterations:**
  - Most screen files delegate to templates that handle safe areas - no direct SafeAreaView needed in screens
  - Dev screens using Stack.Screen with headerShown: true still need SafeAreaView for bottom edge (edges={['bottom']}) since header handles top
  - All 44 templates already have proper SafeAreaView handling (from react-native-safe-area-context)
  - No floating/debug "orange icon" was found in the codebase - this may have been a runtime visual artifact
  - Pre-existing type errors exist in the codebase (CalendarEventMeta, Json types) - these are unrelated to SafeAreaView changes
---

## 2026-01-22 - US-003
- What was implemented: Fixed Android date/time picker state persistence in AddEventTemplate
- Files changed:
  - apps/mobile/src/components/templates/AddEventTemplate.tsx
- **Learnings for future iterations:**
  - On Android, `display="spinner"` for DateTimePicker renders inline but has state persistence issues
  - On Android, use `display="default"` which shows native modal dialog and properly persists state
  - iOS can continue using `display="spinner"` for inline picker experience
  - Pattern: Platform-specific rendering with `Platform.OS === 'ios'` / `Platform.OS === 'android'` conditionals
  - The existing Android dismiss handling (`setShowPicker(false)` on any event type) was already correct
  - The 9:30am default is intentional when `initialStartMinutes` is undefined, not a bug
---

## 2026-01-22 - US-004
- What was implemented: Fixed Android date/time picker in EventEditorModal
- Files changed:
  - apps/mobile/src/components/molecules/EventEditorModal.tsx
- **Learnings for future iterations:**
  - For modals that slide up 92% of screen height, add `paddingTop: Platform.OS === 'android' ? insets.top : 0` to prevent header buttons from being blocked by status bar
  - EventEditorModal now uses same Android date/time picker pattern as AddEventTemplate: `display="default"` (native modal) for Android, `display="spinner"` (inline) for iOS
  - Must close picker state (`setShowPicker(false)`) on ANY Android event including 'dismissed' to prevent modal re-open loop
  - The `useSafeAreaInsets` hook is already imported from 'react-native-safe-area-context' - use `insets.top` for top padding, `insets.bottom` for bottom padding
---

## 2026-01-22 - US-005
- What was implemented: Added defensive UTC parsing for database timestamps to ensure correct timezone handling
- Files changed:
  - apps/mobile/src/lib/supabase/services/calendar-events.ts
  - apps/mobile/src/lib/calendar/actual-display-events.ts
  - apps/mobile/src/lib/supabase/services/actual-evidence-events.ts
- **Learnings for future iterations:**
  - Database timestamps (from Supabase) should always include timezone info (Z suffix or offset), but defensive parsing is safer
  - `parseDbTimestamp()` helper ensures timestamps without timezone info are interpreted as UTC, not local time
  - JavaScript's `new Date("2026-01-22T15:00:00")` (no Z) interprets as LOCAL time, while `new Date("2026-01-22T15:00:00Z")` interprets as UTC
  - This difference can cause events to appear hours off depending on user timezone
  - The same pattern should be used anywhere database timestamps are parsed: `parseDbTimestamp(row.timestamp)` instead of `new Date(row.timestamp)`
  - Pre-existing type errors (CalendarEventMeta export, Json types) are unrelated to timezone handling
---

## 2026-01-27 - US-002
- What was implemented: Created ErrorLogger infrastructure with AsyncStorage persistence for location tracking diagnostics
- Files changed:
  - apps/mobile/src/lib/android-location/error-logger.ts (new)
  - apps/mobile/src/lib/android-location/index.ts (added exports)
- **Learnings for future iterations:**
  - AsyncStorage key for errors: `tm:location:errors`
  - Circular buffer pattern: read all, append/throttle, write back trimmed to max 50
  - Duplicate throttling: scan from end of array for matching category+message within 5-min window, increment count instead of appending
  - ErrorCategory enum: PERMISSION_DENIED, TASK_START_FAILED, TASK_EXECUTION_FAILED, LOCATION_UNAVAILABLE, SYNC_FAILED
  - All public functions (logError, getRecentErrors, clearErrors) wrap in try/catch and fail silently - logging must never crash the app
  - Export both values and types from barrel index.ts: `export { ErrorCategory }` for the enum, `export type { ErrorLogEntry }` for the interface
  - US-003 will integrate logError() calls into existing location code paths (location-task.ts, index.ts, permissions.ts, queue.ts)
---

